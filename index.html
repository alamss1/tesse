<script>
  function getQueryParams() {
    const params = {};
    window.location.search.substring(1).split("&").forEach(pair => {
      const [key, value] = pair.split("=");
      if (key) params[key] = decodeURIComponent(value || "");
    });
    return params;
  }

  const params = getQueryParams();
  const inputId = document.getElementById("inputId");
  const inputNama = document.getElementById("inputNama");

  inputId.value = params.id || "";
  inputNama.value = params.nama || "";

  if (!params.id) inputId.removeAttribute("readonly");
  if (!params.nama) inputNama.removeAttribute("readonly");

  const form = document.getElementById('absenForm');
  const status = document.getElementById('status');
  const btnMasuk = document.getElementById('btnMasuk');
  const btnPulang = document.getElementById('btnPulang');

  btnMasuk.addEventListener('click', () => {
    // Toggle on
    const isActive = btnMasuk.classList.contains('active');
    if (!isActive) {
      btnMasuk.classList.add('active');
      btnPulang.classList.remove('active');
      form.absenMasuk.value = "ya";
      form.absenPulang.value = "tidak";
    } else {
      // If already active, untoggle
      btnMasuk.classList.remove('active');
      form.absenMasuk.value = "tidak";
    }
  });

  btnPulang.addEventListener('click', () => {
    const isActive = btnPulang.classList.contains('active');
    if (!isActive) {
      btnPulang.classList.add('active');
      btnMasuk.classList.remove('active');
      form.absenPulang.value = "ya";
      form.absenMasuk.value = "tidak";
    } else {
      btnPulang.classList.remove('active');
      form.absenPulang.value = "tidak";
    }
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (form.absenMasuk.value === "tidak" && form.absenPulang.value === "tidak") {
      status.textContent = "❗Pilih salah satu jenis absen.";
      return;
    }

    if (!inputId.value || !inputNama.value) {
      status.textContent = "❗ID dan Nama harus diisi.";
      return;
    }

    const keterangan = form.keterangan.value.trim();
    if (!keterangan) {
      status.textContent = "❗Keterangan kegiatan wajib diisi.";
      return;
    }

    const formData = new FormData(form);
    const queryString = new URLSearchParams(formData).toString();

    status.textContent = "Mengirim data...";

    try {
      const res = await fetch(
        'https://script.google.com/macros/s/AKfycbwm1aa9A87_Y2smsxGEtwmlmOC2aPnE5qGmCCWQKZ_On0xFexpETcfGILL_FU66xjoo/exec',
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: queryString,
        }
      );

      if (res.ok) {
        status.textContent = "✅ Data berhasil dikirim!";
        btnMasuk.classList.remove('active');
        btnPulang.classList.remove('active');
        form.absenMasuk.value = "tidak";
        form.absenPulang.value = "tidak";
        form.keterangan.value = "";
      } else {
        status.textContent = "❌ Gagal mengirim data.";
      }
    } catch (error) {
      console.error(error);
      status.textContent = "⚠️ Terjadi kesalahan jaringan.";
    }
  });
</script>
